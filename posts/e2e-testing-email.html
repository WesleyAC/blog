<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wesley Aptekar-Cassels | End-to-end testing emails</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-Italic-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Bold-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/LatoLatin-Regular.woff2" as="font" type="font/woff2">

  <meta property="og:title" content="End-to-end testing emails">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/posts/e2e-testing-email">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="Wesley Aptekar-Cassels">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="/posts/e2e-testing-email">
  <meta name="twitter:title" content="End-to-end testing emails">
  <meta name="twitter:description" content="">

  <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="Wesley Aptekar-Cassels Last 10 blog posts" />

  <link type="text/css" rel="stylesheet" href="/light.css">
  <link type="text/css" rel="stylesheet" href="/dark.css">
</head>

<body>
  <main>
    <nav class="header-nav">
  <a href="/" class="header-logo" title="Wesley Aptekar-Cassels">Wesley Aptekar-Cassels</a>
  <div class="header-links">
    <a href="/feed.xml" target="_blank" title="RSS">
      <div style="width:16px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M56 336c31 0 56 25 56 56s-25 56-56 56-56-25-56-56 25-56 56-56zM0 192c140 0 256 116 256 256h-80c0-48-14-94-48-128S48 272 0 272v-80zM0 64c212 0 384 172 384 384h-80c0-171-133-304-304-304V64z"/></svg></div>
    </a>
    <a href="mailto:me@wesleyac.com" target="_blank" title="Email">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M422 407c-24 25-52 43-85 55s-69 18-105 18c-35 0-66-6-95-17s-53-26-73-46-36-43-47-71-17-58-17-90 6-62 18-89 29-51 50-71 46-35 74-47c28-11 58-17 90-17 28 0 55 4 81 12s49 20 69 36 36 36 48 60 18 53 18 85c0 24-3 46-10 64s-16 34-27 46-24 22-38 28-29 10-45 10-29-4-39-12-15-17-15-29h-3c-6 10-15 19-28 28s-28 13-46 13c-28 0-49-9-64-27s-23-42-23-71c0-17 3-34 9-50s14-31 24-44 23-23 38-31 31-12 49-12c15 0 27 4 38 10 10 6 18 15 21 24h1l5-24h54l-24 113c-1 6-2 12-3 19s-2 13-2 19c0 7 1 13 4 18s7 7 15 7c16 0 29-9 39-26s16-40 16-68c0-24-4-45-12-64s-20-34-34-47-32-23-52-29-41-9-65-9c-26 0-49 4-70 13s-39 22-54 38-27 34-35 56c-8 21-13 44-13 69 0 26 4 51 13 72s21 39 37 54 35 27 57 35 46 12 72 12c33 0 61-6 85-16s45-25 65-43zM231 188c-10 0-18 2-25 8s-14 13-19 22-8 18-11 28-4 20-4 30c0 5 0 10 1 16 1 5 3 10 6 15s7 8 12 11 11 5 19 5c11 0 20-3 28-8s14-13 19-21 9-16 11-26 3-19 3-27c0-6 0-13-1-19s-4-12-7-17-7-9-12-12-12-5-20-5z"/></svg></div>
    </a>
    <a href="https://github.com/WesleyAC" target="_blank" title="GitHub">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 32c124 0 224 103 224 230 0 101-64 188-153 218h-4c-8 0-12-7-12-12 0-8 1-31 1-62 0-21-8-36-16-43 50-6 103-25 103-113 0-25-9-46-23-62 2-6 10-29-2-61h-5c-8 0-27 3-57 24-18-5-37-8-56-8s-38 3-56 8c-30-21-49-24-57-24h-5c-12 32-4 55-2 61-14 16-23 37-23 62 0 88 52 107 102 113-6 6-12 16-14 31-6 3-16 6-26 6-13 0-28-5-39-25 0 0-13-22-35-24-2 0-21 0-1 14 0 0 15 8 25 34 0 0 10 33 53 33 7 0 14 0 22-2v39c0 5-3 11-11 11h-4C64 450 0 364 0 262 0 135 100 32 224 32z"/></svg></div>
    </a>
  </div>
</nav>

    <article>
      <header class="article-header">
        <h1>End-to-end testing emails</h1>
        <div class="article-list-date">
          Feb 16, 2024
        </div>
      </header>

      <div class="article-content">
        <p>I came up with a really slick trick to write E2E tests that deal with sending/receiving emails recently. This is the sort of thing that seems like it&#39;s probably usually sort of a nightmare â€” I wanted to write a test for registering a account on a website, where part of the flow was clicking on a validation link in a email.</p>

<p>The slick trick is a test SMTP server which is also a HTTP server. It&#39;s 39 lines of Javascript and extraordinarily simple:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">SMTPServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">smtp-server</span><span class="dl">"</span><span class="p">).</span><span class="nx">SMTPServer</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">emails</span> <span class="o">=</span> <span class="p">{};</span>

<span class="k">new</span> <span class="nx">SMTPServer</span><span class="p">({</span>
  <span class="na">authOptional</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">onData</span><span class="p">:</span> <span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">chunks</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)));</span>
    <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">chunks</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">envelope</span><span class="p">.</span><span class="nx">rcptTo</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">address</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">email</span> <span class="k">in</span> <span class="nx">emails</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emails</span><span class="p">[</span><span class="nx">email</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">emails</span><span class="p">[</span><span class="nx">email</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">data</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">callback</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">2525</span><span class="p">);</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">email</span> <span class="k">in</span> <span class="nx">emails</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">emails</span><span class="p">[</span><span class="nx">email</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span>

  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/plain</span><span class="dl">"</span><span class="p">});</span>

  <span class="kd">const</span> <span class="nx">initial_num_emails</span> <span class="o">=</span> <span class="nx">emails</span><span class="p">[</span><span class="nx">email</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">emails</span><span class="p">[</span><span class="nx">email</span><span class="p">].</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">initial_num_emails</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">emails</span><span class="p">[</span><span class="nx">email</span><span class="p">][</span><span class="nx">initial_num_emails</span><span class="p">]);</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">2424</span><span class="p">);</span>
</code></pre></div>
<p>This allows you to make a request to <code>http://localhost:2424/test@example.com</code>, which will block until the SMTP server on port 2525 receives a email to <code>test@example.com</code>, at which point it&#39;ll return the full text of the email.</p>

<p>This allows for writing a super simple E2E tests â€” here&#39;s my helper function to register a new user:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">async</span> <span class="kd">function</span> <span class="nx">registerAndLogin</span><span class="p">(</span><span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="dl">'</span><span class="s1">/register</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">randomUUID</span><span class="p">()}</span><span class="s2">@example.com`</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">randomUUID</span><span class="p">();</span>
  <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">getByPlaceholder</span><span class="p">(</span><span class="dl">'</span><span class="s1">Email</span><span class="dl">'</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">getByPlaceholder</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password</span><span class="dl">'</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">verification_email</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="s2">`http://localhost:2424/</span><span class="p">${</span><span class="nx">email</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">getByRole</span><span class="p">(</span><span class="dl">'</span><span class="s1">button</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Sign Up</span><span class="dl">'</span> <span class="p">}).</span><span class="nx">press</span><span class="p">(</span><span class="dl">'</span><span class="s1">Enter</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">verification_email_response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">verification_email</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">verification_email_text</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">verification_email_response</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">verification_link</span> <span class="o">=</span> <span class="sr">/</span><span class="se">(</span><span class="sr">https</span><span class="se">?</span><span class="sr">:</span><span class="se">\/\/[^\s]</span><span class="sr">+</span><span class="se">)</span><span class="sr">/gm</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">verification_email_text</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
  <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="nx">verification_link</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">email</span><span class="p">:</span> <span class="nx">email</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="nx">password</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>Note the nice use of async/await to make the fetch request before pressing the &quot;Sign Up&quot; button.</p>

<p>As soon as I came up with this I immediately started showing it to everyone â€” my friend said &quot;I feel like I just learned a new skateboard trick&quot; â€” excellent praise, in my book.</p>

<p>As a sidenote, if you haven&#39;t used <a href="https://playwright.dev">Playwright</a> for E2E tests, you&#39;re missing out. It&#39;s my opinion that the existence of Playwright moves E2E testing of webapps from being something that&#39;s usually tedious and flaky but sometimes worth the costs to something that&#39;s viable as a primary testing strategy.</p>

<p>Unit tests are best when code is decoupled and complex, but web code tends to be simple but tightly connected. This makes E2E testing a extremely useful strategy, and Playwright makes it simple to write non-flaky E2E tests with a small amount of effort â€” check out the <a href="https://playwright.dev/docs/codegen">codegen tool</a> and the <a href="https://playwright.dev/docs/trace-viewer">trace viewer</a> if you haven&#39;t.</p>

<p>If you want E2E tests to be your main tests, it does require some somewhat careful planning â€” since I <a href="/posts/consider-sqlite">use SQLite</a> and don&#39;t rely on any cloud tools, I can have tests that run extremely quickly (and even in parallel), without relying on any external resources, which is key for this kind of strategy. If you can swing it, though, it&#39;s pretty nice.</p>

      </div>

      <br>
      <!--
ooops, coronavirus happened, guess we're not doing this anymore :(
hopefully someday...
<p>If you're in NYC and want to meet up over lunch/coffee to chat about the future of technology, <a href="mailto:me@wesleyac.com">get in touch with me</a>.</p>
-->

      <br>
    </article>
  </main>
  <script async src="/mathjax/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</body>
</html>
