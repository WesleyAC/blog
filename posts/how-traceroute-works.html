<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wesley Aptekar-Cassels | How traceroute works</title>
  <meta name="description" content="Implementing traceroute in 23 lines of python">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-Italic-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Bold-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/LatoLatin-Regular.woff2" as="font" type="font/woff2">

  <meta property="og:title" content="How traceroute works">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/posts/how-traceroute-works">
  <meta property="og:description" content="Implementing traceroute in 23 lines of python">
  <meta property="og:site_name" content="Wesley Aptekar-Cassels">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="/posts/how-traceroute-works">
  <meta name="twitter:title" content="How traceroute works">
  <meta name="twitter:description" content="Implementing traceroute in 23 lines of python">

  <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="Wesley Aptekar-Cassels Last 10 blog posts" />

  <link type="text/css" rel="stylesheet" href="/light.css">
  <link type="text/css" rel="stylesheet" href="/dark.css">
</head>

<body>
  <main>
    <nav class="header-nav">
  <a href="/" class="header-logo" title="Wesley Aptekar-Cassels">Wesley Aptekar-Cassels</a>
  <div class="header-links">
    <a href="/feed.xml" target="_blank" title="RSS">
      <div style="width:16px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M56 336c31 0 56 25 56 56s-25 56-56 56-56-25-56-56 25-56 56-56zM0 192c140 0 256 116 256 256h-80c0-48-14-94-48-128S48 272 0 272v-80zM0 64c212 0 384 172 384 384h-80c0-171-133-304-304-304V64z"/></svg></div>
    </a>
    <a href="mailto:me@wesleyac.com" target="_blank" title="Email">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M422 407c-24 25-52 43-85 55s-69 18-105 18c-35 0-66-6-95-17s-53-26-73-46-36-43-47-71-17-58-17-90 6-62 18-89 29-51 50-71 46-35 74-47c28-11 58-17 90-17 28 0 55 4 81 12s49 20 69 36 36 36 48 60 18 53 18 85c0 24-3 46-10 64s-16 34-27 46-24 22-38 28-29 10-45 10-29-4-39-12-15-17-15-29h-3c-6 10-15 19-28 28s-28 13-46 13c-28 0-49-9-64-27s-23-42-23-71c0-17 3-34 9-50s14-31 24-44 23-23 38-31 31-12 49-12c15 0 27 4 38 10 10 6 18 15 21 24h1l5-24h54l-24 113c-1 6-2 12-3 19s-2 13-2 19c0 7 1 13 4 18s7 7 15 7c16 0 29-9 39-26s16-40 16-68c0-24-4-45-12-64s-20-34-34-47-32-23-52-29-41-9-65-9c-26 0-49 4-70 13s-39 22-54 38-27 34-35 56c-8 21-13 44-13 69 0 26 4 51 13 72s21 39 37 54 35 27 57 35 46 12 72 12c33 0 61-6 85-16s45-25 65-43zM231 188c-10 0-18 2-25 8s-14 13-19 22-8 18-11 28-4 20-4 30c0 5 0 10 1 16 1 5 3 10 6 15s7 8 12 11 11 5 19 5c11 0 20-3 28-8s14-13 19-21 9-16 11-26 3-19 3-27c0-6 0-13-1-19s-4-12-7-17-7-9-12-12-12-5-20-5z"/></svg></div>
    </a>
    <a href="https://github.com/WesleyAC" target="_blank" title="GitHub">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 32c124 0 224 103 224 230 0 101-64 188-153 218h-4c-8 0-12-7-12-12 0-8 1-31 1-62 0-21-8-36-16-43 50-6 103-25 103-113 0-25-9-46-23-62 2-6 10-29-2-61h-5c-8 0-27 3-57 24-18-5-37-8-56-8s-38 3-56 8c-30-21-49-24-57-24h-5c-12 32-4 55-2 61-14 16-23 37-23 62 0 88 52 107 102 113-6 6-12 16-14 31-6 3-16 6-26 6-13 0-28-5-39-25 0 0-13-22-35-24-2 0-21 0-1 14 0 0 15 8 25 34 0 0 10 33 53 33 7 0 14 0 22-2v39c0 5-3 11-11 11h-4C64 450 0 364 0 262 0 135 100 32 224 32z"/></svg></div>
    </a>
  </div>
</nav>

    <article>
      <header class="article-header">
        <h1>How traceroute works</h1>
        <div class="article-list-date">
          Aug 14, 2017
        </div>
      </header>

      <div class="article-content">
        <p>When you send a packet on the internet, what happens to it? This is a surprisingly difficult question to answer - from the perspective of a developer, you tell the OS that you want a packet to go to a specific machine, and a few hundred milliseconds later, you get a response from that machine. The mechanism that lets that happen though, is incredibly complicated. Since your computer is likely not directly connected to the computer that you want to contact, your packet must get routed over a path that will take it to the machine you want to connect to. While routing is a very interesting problem, it&#39;s not the one that I&#39;m going to talk about in this post - instead, I&#39;m going to explain how you can figure out what route packets that you send are taking.</p>

<p>The question of what route a packet is taking through the network is actually quite difficult - each router only knows where the packet came from, what it&#39;s final destination is, and where it sent the packet to, so no node has the complete information of where the packet is travelling. Given this, how might we find out what path the packet is taking?</p>

<p>The way that this is done is by using the time to live (TTL) field of the packet you&#39;re sending. Each time a packet is forwarded to a new router (called a &quot;hop&quot;), the router decrements the TTL of the packet. If the TTL reaches zero, then the router sends a response to the original machine saying that the TTL was exceeded, and doesn&#39;t forward the packet on. Knowing this, we can send a series of packets (usually UDP packets, but sometimes TCP or ICMP), starting from a TTL of 1 and incrementing the TTL each time, so that each router in the chain will send us a message saying that the TTL has expired. This is what <code>traceroute</code> does:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ traceroute wesleyac.com
traceroute to wesleyac.com (192.64.119.124), 30 hops max, 60 byte packets
 1  gateway.net.recurse.com (10.0.0.1)  3.803 ms  8.466 ms  8.455 ms
 2  207.251.103.45 (207.251.103.45)  8.218 ms  8.236 ms  8.142 ms
 3  te0-7-0-18.ccr21.jfk04.atlas.cogentco.com (38.104.73.241)  8.302 ms  8.566 ms  8.491 ms
 4  telia.jfk04.atlas.cogentco.com (154.54.11.110)  13.512 ms  13.456 ms  13.508 ms
 5  nyk-bb3-link.telia.net (80.91.248.173)  8.177 ms nyk-bb4-link.telia.net (62.115.123.58)  8.236 ms nyk-bb4-link.telia.net (62.115.138.190)  8.218 ms
 6  las-b24-link.telia.net (62.115.138.101)  93.737 ms  90.015 ms  99.226 ms
 7  incapsula-ic-306837-las-b3.c.telia.net (62.115.45.234)  83.381 ms  83.371 ms  83.365 ms
 8  172.20.0.198 (172.20.0.198)  83.382 ms  83.521 ms  83.476 ms
 9  172.22.0.2 (172.22.0.2)  112.526 ms  112.434 ms  112.432 ms
10  172.22.0.10 (172.22.0.10)  84.976 ms  83.413 ms  84.974 ms
11  192.64.119.124 (192.64.119.124)  84.876 ms  79.601 ms  80.544 ms
</code></pre></div>
<p>The first line tells us that we&#39;re sending packets that are 60 bytes long, and that if we haven&#39;t gotten to the server that we want in 30 hops, we&#39;ll just give up. The next lines are each one router in the chain. Each line shows us:</p>

<ul>
<li>The TTL (effectively which router in the chain it is)</li>
<li>The DNS address for the router</li>
<li>The IP address of the router</li>
<li>The time it took to get a response (there are three times because traceroute sends out three packets by default, both for redundancy and to give you an idea of the consistency of the time that the hop takes)</li>
</ul>

<p>This might seem complicated, but it&#39;s actually pretty simple to implement:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">max_hops</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">packet_size</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">33434</span><span class="p">):</span>
    <span class="n">dest_addr</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
    <span class="n">ttl</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">curr_addr</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">send_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
    <span class="n">recv_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">getprotobyname</span><span class="p">(</span><span class="s">'icmp'</span><span class="p">))</span>
    <span class="n">recv_socket</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">''</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

    <span class="k">while</span> <span class="n">curr_addr</span> <span class="o">!=</span> <span class="n">dest_addr</span> <span class="ow">and</span> <span class="n">ttl</span> <span class="o">&lt;</span> <span class="n">max_hops</span><span class="p">:</span>
        <span class="n">send_socket</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_IP</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">IP_TTL</span><span class="p">,</span> <span class="n">ttl</span><span class="p">)</span>
        <span class="n">send_socket</span><span class="p">.</span><span class="n">sendto</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">packet_size</span><span class="p">),</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">curr_addr</span> <span class="o">=</span> <span class="n">recv_socket</span><span class="p">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">512</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'{:2d}</span><span class="se">\t</span><span class="s">{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ttl</span><span class="p">,</span> <span class="n">curr_addr</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'{:2d}</span><span class="se">\t</span><span class="s">*'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ttl</span><span class="p">))</span>

        <span class="n">ttl</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">send_socket</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">recv_socket</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<p>At it&#39;s core, this is pretty simple: just a while loop that sends out packets with incrementing TTL values and prints out the IP addresses of the responses. That&#39;s all traceroute is doing when it&#39;s telling you the route to a host.</p>

<p>I think that traceroute is quite a clever trick to find the route to a specific host, and it&#39;s fascinating to see that it can be implemented in such a small amount of code.</p>

<p><em>Thanks to Christian Ternus, Marcus Klaas de Vries, Ryan Riddle, and Dan Luu for comments/feedback/discussion.</em></p>

      </div>

      <br>
      <!--
ooops, coronavirus happened, guess we're not doing this anymore :(
hopefully someday...
<p>If you're in NYC and want to meet up over lunch/coffee to chat about the future of technology, <a href="mailto:me@wesleyac.com">get in touch with me</a>.</p>
-->

      <br>
    </article>
  </main>
  <script async src="/mathjax/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</body>
</html>
