<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wesley Aptekar-Cassels | Go, Error Handling, and Big Text Files</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-Italic-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Bold-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/LatoLatin-Regular.woff2" as="font" type="font/woff2">

  <meta property="og:title" content="Go, Error Handling, and Big Text Files">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/posts/golang-error-handling-long-lines">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="Wesley Aptekar-Cassels">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="/posts/golang-error-handling-long-lines">
  <meta name="twitter:title" content="Go, Error Handling, and Big Text Files">
  <meta name="twitter:description" content="">

  <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="Wesley Aptekar-Cassels Last 10 blog posts" />

  <link type="text/css" rel="stylesheet" href="/light.css">
  <link type="text/css" rel="stylesheet" href="/dark.css">
</head>

<body>
  <main>
    <nav class="header-nav">
  <a href="/" class="header-logo" title="Wesley Aptekar-Cassels">Wesley Aptekar-Cassels</a>
  <div class="header-links">
    <a href="/feed.xml" target="_blank" title="RSS">
      <div style="width:16px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M56 336c31 0 56 25 56 56s-25 56-56 56-56-25-56-56 25-56 56-56zM0 192c140 0 256 116 256 256h-80c0-48-14-94-48-128S48 272 0 272v-80zM0 64c212 0 384 172 384 384h-80c0-171-133-304-304-304V64z"/></svg></div>
    </a>
    <a href="mailto:me@wesleyac.com" target="_blank" title="Email">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M422 407c-24 25-52 43-85 55s-69 18-105 18c-35 0-66-6-95-17s-53-26-73-46-36-43-47-71-17-58-17-90 6-62 18-89 29-51 50-71 46-35 74-47c28-11 58-17 90-17 28 0 55 4 81 12s49 20 69 36 36 36 48 60 18 53 18 85c0 24-3 46-10 64s-16 34-27 46-24 22-38 28-29 10-45 10-29-4-39-12-15-17-15-29h-3c-6 10-15 19-28 28s-28 13-46 13c-28 0-49-9-64-27s-23-42-23-71c0-17 3-34 9-50s14-31 24-44 23-23 38-31 31-12 49-12c15 0 27 4 38 10 10 6 18 15 21 24h1l5-24h54l-24 113c-1 6-2 12-3 19s-2 13-2 19c0 7 1 13 4 18s7 7 15 7c16 0 29-9 39-26s16-40 16-68c0-24-4-45-12-64s-20-34-34-47-32-23-52-29-41-9-65-9c-26 0-49 4-70 13s-39 22-54 38-27 34-35 56c-8 21-13 44-13 69 0 26 4 51 13 72s21 39 37 54 35 27 57 35 46 12 72 12c33 0 61-6 85-16s45-25 65-43zM231 188c-10 0-18 2-25 8s-14 13-19 22-8 18-11 28-4 20-4 30c0 5 0 10 1 16 1 5 3 10 6 15s7 8 12 11 11 5 19 5c11 0 20-3 28-8s14-13 19-21 9-16 11-26 3-19 3-27c0-6 0-13-1-19s-4-12-7-17-7-9-12-12-12-5-20-5z"/></svg></div>
    </a>
    <a href="https://github.com/WesleyAC" target="_blank" title="GitHub">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 32c124 0 224 103 224 230 0 101-64 188-153 218h-4c-8 0-12-7-12-12 0-8 1-31 1-62 0-21-8-36-16-43 50-6 103-25 103-113 0-25-9-46-23-62 2-6 10-29-2-61h-5c-8 0-27 3-57 24-18-5-37-8-56-8s-38 3-56 8c-30-21-49-24-57-24h-5c-12 32-4 55-2 61-14 16-23 37-23 62 0 88 52 107 102 113-6 6-12 16-14 31-6 3-16 6-26 6-13 0-28-5-39-25 0 0-13-22-35-24-2 0-21 0-1 14 0 0 15 8 25 34 0 0 10 33 53 33 7 0 14 0 22-2v39c0 5-3 11-11 11h-4C64 450 0 364 0 262 0 135 100 32 224 32z"/></svg></div>
    </a>
  </div>
</nav>

    <article>
      <header class="article-header">
        <h1>Go, Error Handling, and Big Text Files</h1>
        <div class="article-list-date">
          Oct 21, 2021
        </div>
      </header>

      <div class="article-content">
        <p>I was recently trying to work with a dataset that was provided to me as a MySQL database dump. Since I&#39;m not a masochist, I certainly wasn&#39;t going to run a MySQL database. Instead, I figured, I&#39;d just write a quick little script to parse the database dump and write it out to a nicer format.</p>

<p>I planned to just grab some off-the-shelf SQL parser, write a tiny bit of hacky glue code, and be done â€” <a href="https://github.com/sqlparser-rs/sqlparser-rs/issues/362">sqlparser-rs</a> was the first thing I reached for, but I quickly found that its support for MySQL was <a href="https://github.com/sqlparser-rs/sqlparser-rs/issues/362">not up to snuff</a>. Abandoning sqlparser-rs, I turned to <a href="https://github.com/pingcap/parser/">pingcap/parser</a>, which claimed to target the MySQL dialect. The only catch: I have to deal with writing Go. But it&#39;s just a tiny script, how bad can it be?</p>

<p>I started with a simple script to loop through all the lines in the file:</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"bufio"</span>
    <span class="s">"log"</span>
    <span class="s">"fmt"</span>
    <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">file</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">scanner</span> <span class="o">:=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">NewScanner</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">scanner</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">ScanLines</span><span class="p">)</span>

    <span class="n">lines</span> <span class="o">:=</span> <span class="m">0</span>

    <span class="k">for</span> <span class="n">scanner</span><span class="o">.</span><span class="n">Scan</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">lines</span><span class="o">++</span>
    <span class="p">}</span>

    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

<span class="p">}</span>
</code></pre></div>
<p>Let&#39;s go ahead and run this with a test file:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ go run main.go test.txt
2
</code></pre></div>
<p>It&#39;s got two lines. Except:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ wc -l test.txt
4 ./test.txt
</code></pre></div>
<p>What&#39;s going on here? Well, it turns out that when a line is longer than <code>bufio.MaxScanTokenSize</code>, which defaults to 65536, the scanner will silently stop scanning. I guess you&#39;re supposed to know that:</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">Err</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Is the invocation that you&#39;re supposed to use, but the compiler won&#39;t warn you, <code>go vet</code> won&#39;t warn you, <a href="https://staticcheck.io"><code>staticcheck</code></a> won&#39;t warn you. It seems like the Go philosophy is that you should simply read the docs for every function you call, think carefully about what kinds of errors can happen, and then write the code to handle them. If you forget, well, shoulda thought more carefully about it!</p>

<p>I was interested in giving Go another shot, after having some major compile-speed frustrations with Rust stemming from people being too clever with types, but I don&#39;t feel that I can take a language where it&#39;s this easy to fuck up error handling seriously.</p>

<p>Error handling can be subtle and nuanced in a lot of ways, but one of my baseline expectations for any modern language is that errors will not be silent: static, default-on tooling should be able to give you a list of every error you aren&#39;t handling, and ideally, just reading the source code should make unhandled errors legible without having to have knowledge of library code. I&#39;m sad that Go seems to fail that benchmark.</p>

<hr>

<p><br></p>

<p>Update: Someone asked me about the feasibility of writing a static check to catch this error. It seem to me that it should be quite easy, given the static analysis infrastructure that exists already for Go, but th problem is that this kind of API (which Go seems to have a lot of) doesn&#39;t express the error semantics in the types, but rather leaves it implicit in the structure of the library code â€” this means that a static check for this can&#39;t be generic, but instead has to specifically know about the error semantics of <code>bufio.Scanner</code>, which are only expressed in the docs. It&#39;s easy to make a static check for this exact thing, but it&#39;s essentially impossible to write a static check that will catch this entire category of error.</p>

      </div>

      <br>
      <!--
ooops, coronavirus happened, guess we're not doing this anymore :(
hopefully someday...
<p>If you're in NYC and want to meet up over lunch/coffee to chat about the future of technology, <a href="mailto:me@wesleyac.com">get in touch with me</a>.</p>
-->

      <br>
    </article>
  </main>
  <script async src="/mathjax/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</body>
</html>
