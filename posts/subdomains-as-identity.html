<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wesley Aptekar-Cassels | Subdomains as identity</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-Italic-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Bold-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/LatoLatin-Regular.woff2" as="font" type="font/woff2">

  <meta property="og:title" content="Subdomains as identity">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/posts/subdomains-as-identity">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="Wesley Aptekar-Cassels">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="/posts/subdomains-as-identity">
  <meta name="twitter:title" content="Subdomains as identity">
  <meta name="twitter:description" content="">

  <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="Wesley Aptekar-Cassels Last 10 blog posts" />

  <link type="text/css" rel="stylesheet" href="/light.css">
  <link type="text/css" rel="stylesheet" href="/dark.css">
</head>

<body>
  <main>
    <nav class="header-nav">
  <a href="/" class="header-logo" title="Wesley Aptekar-Cassels">Wesley Aptekar-Cassels</a>
  <div class="header-links">
    <a href="/feed.xml" target="_blank" title="RSS">
      <div style="width:16px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M56 336c31 0 56 25 56 56s-25 56-56 56-56-25-56-56 25-56 56-56zM0 192c140 0 256 116 256 256h-80c0-48-14-94-48-128S48 272 0 272v-80zM0 64c212 0 384 172 384 384h-80c0-171-133-304-304-304V64z"/></svg></div>
    </a>
    <a href="mailto:me@wesleyac.com" target="_blank" title="Email">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M422 407c-24 25-52 43-85 55s-69 18-105 18c-35 0-66-6-95-17s-53-26-73-46-36-43-47-71-17-58-17-90 6-62 18-89 29-51 50-71 46-35 74-47c28-11 58-17 90-17 28 0 55 4 81 12s49 20 69 36 36 36 48 60 18 53 18 85c0 24-3 46-10 64s-16 34-27 46-24 22-38 28-29 10-45 10-29-4-39-12-15-17-15-29h-3c-6 10-15 19-28 28s-28 13-46 13c-28 0-49-9-64-27s-23-42-23-71c0-17 3-34 9-50s14-31 24-44 23-23 38-31 31-12 49-12c15 0 27 4 38 10 10 6 18 15 21 24h1l5-24h54l-24 113c-1 6-2 12-3 19s-2 13-2 19c0 7 1 13 4 18s7 7 15 7c16 0 29-9 39-26s16-40 16-68c0-24-4-45-12-64s-20-34-34-47-32-23-52-29-41-9-65-9c-26 0-49 4-70 13s-39 22-54 38-27 34-35 56c-8 21-13 44-13 69 0 26 4 51 13 72s21 39 37 54 35 27 57 35 46 12 72 12c33 0 61-6 85-16s45-25 65-43zM231 188c-10 0-18 2-25 8s-14 13-19 22-8 18-11 28-4 20-4 30c0 5 0 10 1 16 1 5 3 10 6 15s7 8 12 11 11 5 19 5c11 0 20-3 28-8s14-13 19-21 9-16 11-26 3-19 3-27c0-6 0-13-1-19s-4-12-7-17-7-9-12-12-12-5-20-5z"/></svg></div>
    </a>
    <a href="https://github.com/WesleyAC" target="_blank" title="GitHub">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 32c124 0 224 103 224 230 0 101-64 188-153 218h-4c-8 0-12-7-12-12 0-8 1-31 1-62 0-21-8-36-16-43 50-6 103-25 103-113 0-25-9-46-23-62 2-6 10-29-2-61h-5c-8 0-27 3-57 24-18-5-37-8-56-8s-38 3-56 8c-30-21-49-24-57-24h-5c-12 32-4 55-2 61-14 16-23 37-23 62 0 88 52 107 102 113-6 6-12 16-14 31-6 3-16 6-26 6-13 0-28-5-39-25 0 0-13-22-35-24-2 0-21 0-1 14 0 0 15 8 25 34 0 0 10 33 53 33 7 0 14 0 22-2v39c0 5-3 11-11 11h-4C64 450 0 364 0 262 0 135 100 32 224 32z"/></svg></div>
    </a>
  </div>
</nav>

    <article>
      <header class="article-header">
        <h1>Subdomains as identity</h1>
        <div class="article-list-date">
          Apr 7, 2022
        </div>
      </header>

      <div class="article-content">
        <p>A common identity scheme for websites is to give users pages like <code>example.com/username</code>. Twitter, Instagram, Twitch, Pinterest, and many other websites use this model. Reddit, TikTok, Mastodon, Lobsters, and several others use a slightly more conservative version of this, with a prefix (either <code>@</code> or <code>u/</code>) before the username.</p>

<p>I think that in many cases, this is a mistake, and using subdomains, like <code>username.example.com</code> is better. Particularly, I think that the subdomain-based model is best for websites where there is minimal interaction between users (blogging, publishing, etc), or where that interaction happens via an open protocol.</p>

<p>Using subdomains for identity offers a few advantages:</p>

<ul>
<li>It makes it easier for users to own their own identities, since you can very easily support using custom domains</li>
<li>It makes it easy to securely allow users full control over the CSS/HTML on their page, without worrying about XSS</li>
<li>It lets you cleanly have information about your website on the top-level domain, without adding the noise of a <code>u/</code> or <code>@</code> prefix to usernames</li>
</ul>

<p>This would be most advantageous for systems like Mastodon — one of the most fundamental mistakes that mastodon made was tying your identity to whoever happens to sysadmin the server you use, and using domains as identity would have almost entirely solved that<sup id="fnref1"><a href="#fn1">1</a></sup>. However, I think that there are notable advantages even for less explicitly federated systems as well.</p>

<p>I personally think that these advantages are quite significant, and software that gives users control over their identity and expression is inherently worth building, but this blog post isn&#39;t about that. I figure if you&#39;re making this decision, you&#39;re capable of thinking through the tradeoffs yourself. This blog post is about concretely, how to implement a system that uses subdomains as identity, and how to extend that system to allow arbitrary custom domains. This is what I do for <a href="https://thoughts.page">thoughts.page</a>, which has been running successfully like this for a year now.</p>

<p>The first question is how to integrate subdomain information into whatever routing system you use. thoughts.page uses <a href="https://github.com/seanmonstar/warp">warp</a>, which has out-of-the-box support for routing based on domain name, but you might not be so lucky in your framework of choice — searching &quot;[framework] wildcard subdomain routing&quot; should point you to relevant documentation. If you don&#39;t find a easy way to do this, a common alternative is to rewrite URLs internally, so that <code>username.example.com/foo</code> gets rewritten to <code>example.com/user/username/foo</code> before it&#39;s handed to your routing library. If your framework doesn&#39;t provide a way to do it, nginx can do the same thing with a <code>rewrite</code> command. However, I&#39;d recommend doing it in your app if possible, since that will make development significantly easier.</p>

<p>Speaking of development, you won&#39;t be able to just use <code>localhost</code> to see your server anymore, since it will require subdomains for routing. Some systems will allow URLs like <code>username.whatever.localhost</code> to work, but if not, you can use <code>lvh.me</code> or <code>vcap.me</code>, which both return <code>127.0.0.1</code> for all requests.</p>

<p>When you deploy your app, you&#39;ll need to get a wildcard HTTPS certificate, instead of one that&#39;s restricted to a particular subdomain. If you use Let&#39;s Encrypt, this makes the process <a href="https://letsencrypt.org/docs/faq/#does-let-s-encrypt-issue-wildcard-certificates">slightly more complicated</a>, but there are <a href="https://www.digitalocean.com/community/tutorials/how-to-create-let-s-encrypt-wildcard-certificates-with-certbot">good instructions online</a> for doing so.</p>

<p>That&#39;s all you need to use subdomains for identity. If you want to go the whole hog and allow users to use custom domains, though, you need to do a little bit more. The main problem here is HTTPS: you need to have a certificate for whatever domain they choose to use, and your web server needs to be able to dynamically pick which HTTPS cert to use based on the domain name. Nginx added support for this in 1.15.9, which is relatively recent — it&#39;s in the most recent Debian version as of this writing (bullseye), but not in the previous version (buster). You can set this up by using the <code>$ssl_server_name</code> variable in your <code>ssl_certificate</code> and <code>ssl_certificate_key</code> variables, like so (assuming the default certbot setup):</p>
<div class="highlight"><pre><code class="language-" data-lang="">ssl_certificate /etc/letsencrypt/live/$ssl_server_name/fullchain.pem; 
ssl_certificate_key /etc/letsencrypt/live/$ssl_server_name/privkey.pem;
</code></pre></div>
<p>That&#39;s not enough, though, since you also need to actually get the keys. I do this by having a small script<sup id="fnref2"><a href="#fn2">2</a></sup> that reads the database to look for users with custom domains, and attempts to renew their certificates:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="nb">cd</span> <span class="si">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span><span class="si">)</span>

certbot certonly <span class="nt">--noninteractive</span> <span class="nt">--keep-until-expiring</span> <span class="nt">--dns-digitalocean</span> <span class="nt">--dns-digitalocean-credentials</span> /root/digitalocean-secret.ini <span class="nt">-d</span> thoughts.page <span class="nt">-d</span> <span class="s1">'*.thoughts.page'</span>

sqlite3 thoughts.sqlite3 <span class="s2">"SELECT domain FROM domains"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">".thoughts.page$"</span> | <span class="k">while </span><span class="nb">read </span>DOMAIN
<span class="k">do
    </span>certbot certonly <span class="nt">--noninteractive</span> <span class="nt">--keep-until-expiring</span> <span class="nt">--webroot</span> <span class="nt">--webroot-path</span> /var/cert-webroot/ <span class="nt">--domain</span> <span class="s2">"</span><span class="nv">$DOMAIN</span><span class="s2">"</span>
<span class="k">done</span>

<span class="c"># Needed because nginx SNI doesn't run as root</span>
<span class="nb">chmod</span> <span class="nt">-R</span> 755 /etc/letsencrypt/live/
<span class="nb">chmod</span> <span class="nt">-R</span> 755 /etc/letsencrypt/archive/

<span class="c"># Nginx needs a reload to pick up new certs</span>
systemctl reload nginx
</code></pre></div>
<p>This is run every five minutes by a cron job. I could have the user adding a new custom domain trigger this, but so far, I haven&#39;t felt the need to do that.</p>

<p>The <code>/var/cert-webroot/</code> directory referenced in that script is served by nginx, using the following snippet:</p>
<div class="highlight"><pre><code class="language-" data-lang="">location /.well-known/acme-challenge/ {
    root /var/cert-webroot/;
}
</code></pre></div>
<p>This allows the app server to keep on running while the certs are being renewed, free of any interference from certbot.</p>

<p>This relatively simple change makes it easy for people to own their own identities if that&#39;s important to them, without imposing any sort of burden on less technically-inclined users to think about it. It also creates a softer gradient towards self-hosting, allowing people who are comfortable setting up a DNS record but not administering a server to own their own identities. Next time you&#39;re making a website with users, I hope you&#39;ll consider using subdomains as identity.</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>I say &quot;almost entirely&quot;, since there should still ideally be some way for clients to have cryptographic proof of their identity, which they can use to delegate the ability to manage their account to a particular server. Implementing this well is quite complex, but I think doable and important, as well. If you&#39;re working on this kind of thing and want to chat about it, please do drop me a line :)&nbsp;<a href="#fnref1">&#8617;</a></p>
</li>

<li id="fn2">
<p>One of the <a href="/posts/consider-sqlite">many advantages</a> to using SQLite is that it makes writing small scripts like this really easy&nbsp;<a href="#fnref2">&#8617;</a></p>
</li>

</ol>
</div>

      </div>

      <br>
      <!--
ooops, coronavirus happened, guess we're not doing this anymore :(
hopefully someday...
<p>If you're in NYC and want to meet up over lunch/coffee to chat about the future of technology, <a href="mailto:me@wesleyac.com">get in touch with me</a>.</p>
-->

      <br>
    </article>
  </main>
  <script async src="/mathjax/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</body>
</html>
