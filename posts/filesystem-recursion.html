<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wesley Aptekar-Cassels | Recursive Filesystem Entries</title>
  <meta name="description" content="Abusing FAT for fun and profit">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Regular-Italic-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/Harriet-v2-Text-Bold-latin1.woff2" as="font" type="font/woff2">
  <link rel="preload" href="/fonts/LatoLatin-Regular.woff2" as="font" type="font/woff2">

  <meta property="og:title" content="Recursive Filesystem Entries">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/posts/filesystem-recursion">
  <meta property="og:description" content="Abusing FAT for fun and profit">
  <meta property="og:site_name" content="Wesley Aptekar-Cassels">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="/posts/filesystem-recursion">
  <meta name="twitter:title" content="Recursive Filesystem Entries">
  <meta name="twitter:description" content="Abusing FAT for fun and profit">

  <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="Wesley Aptekar-Cassels Last 10 blog posts" />

  <link type="text/css" rel="stylesheet" href="/light.css">
  <link type="text/css" rel="stylesheet" href="/dark.css">
</head>

<body>
  <main>
    <nav class="header-nav">
  <a href="/" class="header-logo" title="Wesley Aptekar-Cassels">Wesley Aptekar-Cassels</a>
  <div class="header-links">
    <a href="/feed.xml" target="_blank" title="RSS">
      <div style="width:16px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M56 336c31 0 56 25 56 56s-25 56-56 56-56-25-56-56 25-56 56-56zM0 192c140 0 256 116 256 256h-80c0-48-14-94-48-128S48 272 0 272v-80zM0 64c212 0 384 172 384 384h-80c0-171-133-304-304-304V64z"/></svg></div>
    </a>
    <a href="mailto:me@wesleyac.com" target="_blank" title="Email">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M422 407c-24 25-52 43-85 55s-69 18-105 18c-35 0-66-6-95-17s-53-26-73-46-36-43-47-71-17-58-17-90 6-62 18-89 29-51 50-71 46-35 74-47c28-11 58-17 90-17 28 0 55 4 81 12s49 20 69 36 36 36 48 60 18 53 18 85c0 24-3 46-10 64s-16 34-27 46-24 22-38 28-29 10-45 10-29-4-39-12-15-17-15-29h-3c-6 10-15 19-28 28s-28 13-46 13c-28 0-49-9-64-27s-23-42-23-71c0-17 3-34 9-50s14-31 24-44 23-23 38-31 31-12 49-12c15 0 27 4 38 10 10 6 18 15 21 24h1l5-24h54l-24 113c-1 6-2 12-3 19s-2 13-2 19c0 7 1 13 4 18s7 7 15 7c16 0 29-9 39-26s16-40 16-68c0-24-4-45-12-64s-20-34-34-47-32-23-52-29-41-9-65-9c-26 0-49 4-70 13s-39 22-54 38-27 34-35 56c-8 21-13 44-13 69 0 26 4 51 13 72s21 39 37 54 35 27 57 35 46 12 72 12c33 0 61-6 85-16s45-25 65-43zM231 188c-10 0-18 2-25 8s-14 13-19 22-8 18-11 28-4 20-4 30c0 5 0 10 1 16 1 5 3 10 6 15s7 8 12 11 11 5 19 5c11 0 20-3 28-8s14-13 19-21 9-16 11-26 3-19 3-27c0-6 0-13-1-19s-4-12-7-17-7-9-12-12-12-5-20-5z"/></svg></div>
    </a>
    <a href="https://github.com/WesleyAC" target="_blank" title="GitHub">
      <div style="width:18px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 32c124 0 224 103 224 230 0 101-64 188-153 218h-4c-8 0-12-7-12-12 0-8 1-31 1-62 0-21-8-36-16-43 50-6 103-25 103-113 0-25-9-46-23-62 2-6 10-29-2-61h-5c-8 0-27 3-57 24-18-5-37-8-56-8s-38 3-56 8c-30-21-49-24-57-24h-5c-12 32-4 55-2 61-14 16-23 37-23 62 0 88 52 107 102 113-6 6-12 16-14 31-6 3-16 6-26 6-13 0-28-5-39-25 0 0-13-22-35-24-2 0-21 0-1 14 0 0 15 8 25 34 0 0 10 33 53 33 7 0 14 0 22-2v39c0 5-3 11-11 11h-4C64 450 0 364 0 262 0 135 100 32 224 32z"/></svg></div>
    </a>
  </div>
</nav>

    <article>
      <header class="article-header">
        <h1>Recursive Filesystem Entries</h1>
        <div class="article-list-date">
          Aug 28, 2017
        </div>
      </header>

      <div class="article-content">
        <p>I made a fun file today:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ df -h
Filesystem      Size  Used Avail Use% Mounted on
...
/dev/loop0      232K   22K  210K  10% /mnt/test
$ ls -lh /mnt/test/
total 4.0G
-rwxr-xr-x 1 root root 4.0G Aug 28 04:05 forever.txt
$ cat /mnt/test/forever.txt | wc -c
4294967295
</code></pre></div>
<p><code>forever.txt</code> is a 4GB file sitting on a 232K filesystem - and it doesn&#39;t just say it&#39;s 4GB in size, it actually has 4GB of data. How does that work?</p>

<p>In order to understand this, we need to take a step back and look at how filesystems store data. Filesystems are often divided into small &quot;clusters&quot; (typically anywhere from 512B - 64KB in size). One of the jobs of a filesystem is to transform a file name into a list of clusters containing the data in that file. <a href="https://en.wikipedia.org/wiki/File_Allocation_Table">FAT</a> does this with a linked list structure - for each cluster, the File Allocation Table keeps the number of the next cluster in the same file.</p>

<p>If we <a href="http://fejlesztek.hu/create-a-fat-file-system-image-on-linux/">create a FAT filesystem</a> and put some files on it, we can open it in a hex editor and see what&#39;s going on. The first 512 bytes are the boot sector - immediately after the boot sector is the File Allocation Table<sup id="fnref1"><a href="#fn1">1</a></sup>:</p>
<div class="highlight"><pre><code class="language-" data-lang="">00000200: f8ff ff00 4000 0560 0007 8000 09a0 000b  ....@..`........
00000210: c000 0df0 ff00 0000 0000 0000 0000 0000  ................
</code></pre></div>
<p>The File Allocation Table is essentially a flat array of pointers to the next block in a file. Since I&#39;m using FAT12, each entry in the FAT is 12 bits. There are a few special values:</p>

<ul>
<li><code>0x000</code> is an unused block</li>
<li><code>0xFF0</code> - <code>0xFF6</code> is a reserved cluster</li>
<li><code>0xFF7</code> is a bad cluster</li>
<li><code>0xFF8</code> - <code>0xFFF</code> is the last cluster in a file</li>
</ul>

<p>Since there are 8 bits in a byte, and we have 12 bit values, we pack 2 values in every three bytes. This is done in a somewhat non-intuitive way: if we have the three bytes <code>0xABCDEF</code>, then our two values are <code>0xDAB</code> and <code>0xEFC</code>.</p>

<p>Knowing this, we can easily decipher our FAT:</p>
<div class="highlight"><pre><code class="language-" data-lang="">FF8 FFF 000 004 005 006 007 008 009 00A 00B 00C 00D FFF
</code></pre></div>
<p>This shows that we have 3 files: two small (â‰¤ 1 cluster) files and one 12 cluster file.<sup id="fnref2"><a href="#fn2">2</a></sup></p>

<p>At this point, it should be fairly simple to see how I made that 4GB file from the beginning - simply change the last <code>0xFFF</code> to <code>0x003</code>, and instead of being a linked list, it&#39;s now a graph with a cycle. However, there&#39;s one more thing that has to be done - the filesystem still knows the size of the old file, since that&#39;s saved in the directory entry. Let&#39;s look at the directory entry in our hex editor:</p>
<div class="highlight"><pre><code class="language-" data-lang="">00000600: 4166 006f 0072 0065 0076 000f 0035 6500  Af.o.r.e.v...5e.
00000610: 7200 2e00 7400 7800 7400 0000 0000 ffff  r...t.x.t.......
00000620: 464f 5245 5645 5220 5458 5420 0064 a440  FOREVER TXT .d.@
00000630: 1c4b 1c4b 0000 a440 1c4b 0300 1e50 0000  .K.K...@.K...P..
</code></pre></div>
<p>The first two lines are <a href="http://home.teleport.com/%7Ebrainy/lfn.htm">long filename (LFN)</a> entries - since FAT natively only supports 8 character filenames and 3 character extensions, LFNs were added to allow arbitrarily long unicode filenames. The next two lines are the standard filename entry, which contain the filename, modification/creation times, attributes, first cluster number, and file size.</p>

<p>The reason that the filesize needs to be known is that the file may end partway through a cluster, so providing the filesize allows the driver to know where to stop reading the file. Unfortunately, it also means that we can&#39;t make the file size infinite, so I&#39;ll have to settle for 4GB (the largest possible filesize). The last 4 bytes of the directory entry are the file size, so if we change them to <code>0xFFFFFFFF</code>, we get a 4GB file that only takes up a few KB on disk!</p>

<p>While this is a fun trick, it&#39;s not super useful - there isn&#39;t really any practical application for this, and FAT is largely obsolete now. However, I hope that this has been a good introduction to how filesystems work - if you&#39;re interested in learning more about filesystems, I recommend the later chapters of <a href="http://pages.cs.wisc.edu/%7Eremzi/OSTEP/">the comet book</a></p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>Actually, two copies of the file allocation table, for redundancy.&nbsp;<a href="#fnref1">&#8617;</a></p>
</li>

<li id="fn2">
<p>Interestingly, I only added the 12 sector file - the other two seem to exist in every FAT12 filesystem. I&#39;m not sure what they&#39;re for.&nbsp;<a href="#fnref2">&#8617;</a></p>
</li>

</ol>
</div>

      </div>

      <br>
      <!--
ooops, coronavirus happened, guess we're not doing this anymore :(
hopefully someday...
<p>If you're in NYC and want to meet up over lunch/coffee to chat about the future of technology, <a href="mailto:me@wesleyac.com">get in touch with me</a>.</p>
-->

      <br>
    </article>
  </main>
  <script async src="/mathjax/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</body>
</html>
